<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả Chẩn đoán Viêm Xoang - Sinusitis AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .severity-low {
            background-color: #22c55e;
            color: white;
        }

        /* green-500 */
        .severity-medium {
            background-color: #f97316;
            color: white;
        }

        /* orange-500 */
        .severity-high {
            background-color: #ef4444;
            color: white;
        }

        /* red-500 */
        .severity-critical {
            background-color: #dc2626;
            color: white;
            animation: pulse 1.5s infinite;
        }

        /* red-600 */
        .severity-info {
            background-color: #3b82f6;
            color: white;
        }

        /* Simplified styles, graphs removed */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 9999px;
            background: #f1f5f9;
            color: #0f172a;
            border: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }

        /* blue-500 */

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        .tab-button.active {
            border-bottom-color: #06b6d4;
            color: #06b6d4;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
    </style>
    <script>
        // Small helpers for UX actions
        function copySummary() {
            const el = document.getElementById('summaryText');
            if (!el) return;
            const text = el.innerText.trim();
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyBtn');
                if (btn) {
                    const original = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i>Đã sao chép';
                    setTimeout(() => (btn.innerHTML = original), 1500);
                }
            });
        }

        function toggleExplanations() {
            const more = document.getElementById('more-explanations');
            const btn = document.getElementById('toggleExplainBtn');
            if (!more || !btn) return;
            const hidden = more.classList.toggle('hidden');
            btn.innerHTML = hidden
                ? '<i class="fas fa-chevron-down mr-2"></i>Xem thêm luận giải'
                : '<i class="fas fa-chevron-up mr-2"></i>Thu gọn luận giải';
        }

        function doPrint() {
            window.print();
        }
    </script>
</head>

<body class="bg-slate-50">
    <div class="max-w-5xl mx-auto px-4 py-8">
        <!-- Hero / Header -->
        <header class="mb-6">
            <div class="flex items-center justify-between mb-2">
                <a href="{{ url_for('medical.landing') }}"
                    class="text-cyan-600 hover:text-cyan-700 text-sm font-medium">
                    <i class="fas fa-arrow-left mr-1"></i> Quay lại trang chủ
                </a>
                <div class="flex gap-2">
                    <button id="copyBtn" onclick="copySummary()"
                        class="px-3 py-1.5 text-sm rounded-md bg-white border border-slate-200 text-slate-700 hover:bg-slate-50">
                        <i class="fas fa-copy mr-2"></i>Sao chép tóm tắt
                    </button>
                    <button onclick="doPrint()"
                        class="px-3 py-1.5 text-sm rounded-md bg-white border border-slate-200 text-slate-700 hover:bg-slate-50">
                        <i class="fas fa-print mr-2"></i>In
                    </button>
                </div>
            </div>
            <div class="rounded-xl overflow-hidden bg-gradient-to-r from-cyan-600 to-blue-600 text-white">
                <div class="p-6 md:p-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="h-12 w-12 rounded-lg bg-white/10 flex items-center justify-center">
                            <i class="fa-solid fa-stethoscope text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold">Báo cáo Phân tích Triệu chứng</h1>
                            <p class="text-white/90 text-sm md:text-base">Kết quả được tạo tự động từ hệ thống luật y
                                khoa</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-1.5 rounded-full text-sm font-semibold bg-white/10 border border-white/20">
                            Mức độ: {{ diagnosis.severity_raw }}
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Result Card -->
        <section class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden mb-8">
            <div class="p-6 md:p-8 {{ 'severity-' + diagnosis.severity }}">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div id="summaryText" class="text-white">
                        <h2 class="text-2xl font-bold mb-1 flex items-center">
                            {% if diagnosis.severity == 'critical' %}
                            <i class="fas fa-biohazard mr-3"></i>
                            {% elif diagnosis.severity == 'high' or diagnosis.severity == 'medium' %}
                            <i class="fas fa-head-side-cough mr-3"></i>
                            {% else %}
                            <i class="fas fa-check-circle mr-3"></i>
                            {% endif %}
                            Kết luận: {{ diagnosis.disease_label }}
                        </h2>
                        <p class="opacity-90">Mức độ: <strong>{{ diagnosis.severity_raw }}</strong></p>
                    </div>
                    <a href="{{ url_for('medical.interview') }}"
                        class="inline-flex items-center px-4 py-2 rounded-md bg-white/10 border border-white/30 text-white hover:bg-white/20">
                        <i class="fas fa-redo mr-2"></i> Phỏng vấn lại
                    </a>
                </div>
            </div>
            <div class="p-6 md:p-8">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">Khuyến nghị chính cho bạn</h3>

                {# Severity-aware styles #}
                {% set sev = diagnosis.severity %}
                {% if sev == 'critical' %}
                {% set badge_color = 'bg-red-600 text-white' %}
                {% set icon_main = 'fa-triangle-exclamation' %}
                {% elif sev == 'high' %}
                {% set badge_color = 'bg-red-500 text-white' %}
                {% set icon_main = 'fa-triangle-exclamation' %}
                {% elif sev == 'medium' %}
                {% set badge_color = 'bg-amber-500 text-white' %}
                {% set icon_main = 'fa-circle-exclamation' %}
                {% elif sev == 'Info' or sev == 'info' %}
                {% set badge_color = 'bg-blue-500 text-white' %}
                {% set icon_main = 'fa-circle-info' %}
                {% else %}
                {% set badge_color = 'bg-emerald-500 text-white' %}
                {% set icon_main = 'fa-circle-check' %}
                {% endif %}

                {% if recommendations and recommendations|length > 0 %}
                {% set full_text = recommendations|join('\n') %}
                {% set sections = {
                'summary': [],
                'drivers': [],
                'home_care': [],
                'medical_visit': [],
                'emergency': [],
                'notes': []
                } %}
                {% set parser = namespace(current=None) %}
                {% for raw_line in recommendations %}
                {% set line = raw_line.strip() %}
                {% if line.startswith('@') %}
                {% set parts = line.split(':', 1) %}
                {% if parts|length == 2 %}
                {% set key = parts[0][1:] %}
                {% if key in sections %}
                {% set parser.current = key %}
                {% set inline_text = parts[1].strip() %}
                {% if inline_text %}
                {% set _ = sections[key].append(inline_text) %}
                {% endif %}
                {% else %}
                {% set parser.current = None %}
                {% endif %}
                {% else %}
                {% set parser.current = None %}
                {% endif %}
                {% elif parser.current %}
                {% set cleaned = line %}
                {% if cleaned.startswith('- ') %}
                {% set cleaned = cleaned[2:] %}
                {% endif %}
                {% if cleaned %}
                {% set _ = sections[parser.current].append(cleaned) %}
                {% endif %}
                {% endif %}
                {% endfor %}

                {% set metric = namespace(total=0) %}
                {% for key in sections %}
                {% set metric.total = metric.total + (sections[key]|length) %}
                {% endfor %}
                {% set has_structured = metric.total > 0 %}

                <div class="mb-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div class="flex items-center gap-2">
                        <div class="h-9 w-9 rounded-full {{ badge_color }} flex items-center justify-center">
                            <i class="fa-solid {{ icon_main }}"></i>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-slate-500">Kết luận chính</div>
                            <div class="text-base md:text-lg font-semibold text-slate-900">
                                {{ diagnosis.disease_label }} ({{ diagnosis.severity_raw }})
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-500">
                        <span class="inline-flex items-center gap-1"><i
                                class="fa-solid fa-circle-dot text-slate-400"></i> Hệ thống suy diễn từ {{
                            fired_rules_count }} luật.</span>
                    </div>
                </div>

                {% if has_structured %}
                {% set section_order = ['summary','drivers','home_care','medical_visit','emergency','notes'] %}
                {% set section_labels = {
                'summary': 'Tóm tắt nhanh',
                'drivers': 'Vì sao hệ thống kết luận',
                'home_care': 'Chăm sóc tại nhà',
                'medical_visit': 'Khi cần gặp bác sĩ',
                'emergency': 'Dấu hiệu cần cấp cứu',
                'notes': 'Ghi chú thêm'
                } %}
                {% set section_icons = {
                'summary': 'fa-clipboard-list text-cyan-600',
                'drivers': 'fa-microscope text-indigo-600',
                'home_care': 'fa-house-medical text-emerald-600',
                'medical_visit': 'fa-user-doctor text-sky-600',
                'emergency': 'fa-triangle-exclamation text-red-500',
                'notes': 'fa-note-sticky text-slate-500'
                } %}
                {% set section_styles = {
                'summary': 'bg-slate-50 border border-slate-100',
                'drivers': 'bg-indigo-50 border border-indigo-100',
                'home_care': 'bg-emerald-50 border border-emerald-100',
                'medical_visit': 'bg-sky-50 border border-sky-100',
                'emergency': 'bg-rose-50 border border-rose-100',
                'notes': 'bg-white border border-slate-200'
                } %}
                {% set section_text = {
                'summary': 'text-slate-700',
                'drivers': 'text-slate-700',
                'home_care': 'text-emerald-800',
                'medical_visit': 'text-slate-700',
                'emergency': 'text-rose-700',
                'notes': 'text-slate-700'
                } %}

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for key in section_order %}
                    {% if sections[key] %}
                    {% set icon_classes = section_icons[key] %}
                    {% set card_classes = section_styles.get(key, 'bg-slate-50 border border-slate-100') %}
                    {% set text_classes = section_text.get(key, 'text-slate-700') %}
                    <div class="rounded-lg p-4 h-full flex flex-col {{ card_classes }} shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fa-solid {{ icon_classes }}"></i>
                            <h4 class="text-sm font-semibold text-slate-900">{{ section_labels[key] }}</h4>
                        </div>
                        <ul class="space-y-1.5 text-sm {{ text_classes }}">
                            {% for item in sections[key] %}
                            <li>• {{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="bg-slate-50 border border-slate-100 rounded-lg p-4">
                    <p class="text-sm text-slate-700 whitespace-pre-line">{{ full_text }}</p>
                </div>
                {% endif %}

                <div class="mt-4">
                    <button type="button"
                        onclick="const d=document.getElementById('full-reco'); const h=d.classList.toggle('hidden'); this.innerHTML=h?'Xem đầy đủ khuyến nghị chi tiết':'Thu gọn khuyến nghị chi tiết';"
                        class="text-sm text-cyan-700 hover:text-cyan-800">
                        Xem đầy đủ khuyến nghị chi tiết
                    </button>
                    <div id="full-reco" class="hidden mt-3">
                        <div class="text-xs text-slate-500 mb-1">Nội dung chi tiết (dạng đầy đủ từ cơ sở tri thức):
                        </div>
                        <pre
                            class="whitespace-pre-wrap text-sm text-slate-700 bg-slate-50 border border-slate-100 rounded-lg p-3">{{ full_text }}</pre>
                    </div>
                </div>
                {% else %}
                <p class="text-slate-500">Không có khuyến nghị.</p>
                {% endif %}
            </div>
        </section>

        <!-- Details Section -->
        <div class="space-y-8">
            <!-- Symptoms & Logic -->
            <div class="space-y-8">
                <!-- Input Symptoms -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold text-slate-800">Triệu chứng đã cung cấp</h3>
                        {% if fired_rules_count is defined %}
                        <span class="text-sm text-slate-500">Quy tắc kích hoạt: <strong>{{ fired_rules_count
                                }}</strong>{% if inference_steps is defined %} • Bước suy diễn: <strong>{{
                                inference_steps }}</strong>{% endif %}</span>
                        {% endif %}
                    </div>
                    <div class="flex flex-wrap gap-2">
                        {% for symptom in input_symptoms %}
                        <span class="chip"><i class="fas fa-check text-green-500"></i>{{ symptom }}</span>
                        {% else %}
                        <span class="text-slate-500">Không có dữ liệu triệu chứng.</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Inference Logic -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-slate-800">Luận giải của AI</h3>
                        {% if rule_explanations and rule_explanations|length > 4 %}
                        <button id="toggleExplainBtn" onclick="toggleExplanations()"
                            class="text-cyan-600 hover:text-cyan-700 text-sm">
                            <i class="fas fa-chevron-down mr-2"></i>Xem thêm luận giải
                        </button>
                        {% endif %}
                    </div>
                    <p class="text-sm text-slate-600 mt-1 mb-4">Hệ thống đã kích hoạt các luật suy diễn sau để đưa ra
                        kết luận:</p>

                    <ul class="space-y-3 text-sm">
                        {% set total = rule_explanations|length %}
                        {% for explanation in rule_explanations %}
                        {% if loop.index <= 4 %} <li class="flex items-start">
                            <i class="fas fa-lightbulb text-yellow-400 mr-3 mt-1"></i>
                            <span class="text-slate-800">{{ explanation }}</span>
                            </li>
                            {% endif %}
                            {% endfor %}
                    </ul>
                    {% if rule_explanations and rule_explanations|length > 4 %}
                    <ul id="more-explanations" class="space-y-3 text-sm mt-3 hidden">
                        {% for explanation in rule_explanations[4:] %}
                        <li class="flex items-start">
                            <i class="fas fa-lightbulb text-yellow-400 mr-3 mt-1"></i>
                            <span class="text-slate-800">{{ explanation }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    {% if not rule_explanations or rule_explanations|length == 0 %}
                    <p class="text-slate-500">Không có luật nào được kích hoạt.</p>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <footer class="mt-12 text-center">
            <a href="{{ url_for('medical.interview') }}"
                class="px-6 py-3 bg-cyan-600 text-white rounded-lg font-semibold hover:bg-cyan-700 transition-colors">
                <i class="fas fa-redo-alt mr-2"></i> Phỏng vấn lại với triệu chứng khác
            </a>
        </footer>
    </div>

    <!-- Graphs removed per requirement: focus on accuracy and UX -->
</body>

</html>